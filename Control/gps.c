/*
 * test.c
 *
 *  Created on: Oct 4, 2019
 *      Author: mahmo
 */
#include "STD_TYPES.h"
#include <avr/interrupt.h>
#include "USART_128.h"
#include "gps.h"

/* This module prvoides lat, lon, and alt in meters passd by referance
 * please note that alt is meaured from the sea level  not from ground
 */

void gps_init(void)
{

	SREG|= 0b10000000; //enabling INT
	// first init the uart at 9600

	u8 gps_init_9600[37]= {0xB5, 0x62, 0x06, 0x00, 0x14, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD0, 0x08, 0x00, 0x00, 0x00, 0xC2, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xB8, 0x42, 0xB5, 0x62, 0x06, 0x00, 0x01, 0x00, 0x01, 0x08, 0x22};
	u8 i =0;
	UART1_init(103);
	for (u8 i=0 ; i<37 ; i++){
		UART1_sendByte(gps_init_9600[i]);
	}
		UART1_init(8);


	// now init the uart to 115200
	u8 gps_init_115200 [79]= {0xB5 ,0x62, 0x06, 0x08, 0x06, 0x00, 0x64, 0x00, 0x01, 0x00, 0x01, 0x00, 0x7A, 0x12, 0xB5, 0x62, 0x06, 0x08, 0x00, 0x00, 0x0E, 0x30,
			0xB5, 0x62, 0x06, 0x01, 0x08 ,0x00 ,0x01 ,0x06 ,0x00 ,0x01 ,0x00 ,0x00 ,0x00 ,0x00 ,0x17 ,0xDA ,0xB5 ,0x62 ,0x06 ,0x01 ,0x02 ,0x00 ,0x01 ,0x06 ,0x10 ,0x39,
			0xB5, 0x62, 0x06, 0x09, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x17, 0x31, 0xBF, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00, 0x06, 0x09, 0x17, 0x40};
	for (u8 i=0 ; i<79 ; i++){
		UART1_sendByte(gps_init_115200[i]);
	}

}
volatile u8 gps_data[60];

u8 GPS_Read(accel *position, accel *velocity)
{
	u8 flag;


		flag = gps_data[16]; //Gps fix (PASS IT ONE I GET THE VARIABLE)
		position->x = ((((s32)(gps_data[18])& 0xFF)) | (((s32)(gps_data[19]& 0xFF)) <<8)|(((s32)(gps_data[20]& 0xFF))<<16) | (((s32)(gps_data[21]& 0xFF))<<24))/100.0;
		position->y = ((((s32)(gps_data[22])& 0xFF)) | (((s32)(gps_data[23]& 0xFF)) <<8)|(((s32)(gps_data[24]& 0xFF))<<16) | (((s32)(gps_data[25]& 0xFF))<<24))/100.0;
		position->z = ((((s32)(gps_data[26])& 0xFF)) | (((s32)(gps_data[27]& 0xFF)) <<8)|(((s32)(gps_data[28]& 0xFF))<<16) | (((s32)(gps_data[29]& 0xFF))<<24))/100.0;
		velocity->x = ((((s32)(gps_data[34])& 0xFF)) | (((s32)(gps_data[35]& 0xFF)) <<8)|(((s32)(gps_data[36]& 0xFF))<<16) | (((s32)(gps_data[37]& 0xFF))<<24))/100.0;
		velocity->y = ((((s32)(gps_data[38])& 0xFF)) | (((s32)(gps_data[39]& 0xFF)) <<8)|(((s32)(gps_data[40]& 0xFF))<<16) | (((s32)(gps_data[41]& 0xFF))<<24))/100.0;
		velocity->z = ((((s32)(gps_data[42])& 0xFF)) | (((s32)(gps_data[43]& 0xFF)) <<8)|(((s32)(gps_data[44]& 0xFF))<<16) | (((s32)(gps_data[45]& 0xFF))<<24))/100.0;



return flag;

}


